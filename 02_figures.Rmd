---
title: "02_figures"
author: "Adriana Uscanga"
date: '2022-05-16'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Figures 1 and 2. Timeline and Study Area Map

# Figure 3. Break example

# Figure 4. Variables
```{r}
p66139_2 <- read_csv("output/ts_plots/66139_2.csv")

annual <- p66139_2 %>%
  arrange(sat_time) %>%
  mutate(year = year(date)) %>%
  group_by(year) %>%
  summarize(sat_time = as.numeric(sat_time),
            time1= paste0(year,"-01-01"),
            time2 = paste0(year+1,"-01-01"),
            ndvi_annual_sd = sd(ndvi),
            ndvi_annual_mean = mean(ndvi),
            ndvi_sd_1 = ndvi_annual_mean - ndvi_annual_sd,
            ndvi_sd_2 = ndvi_annual_mean + ndvi_annual_sd,
            ndvi_annual_min = min(ndvi),
            is_min = ifelse(ndvi == ndvi_annual_min, "min", NA)) %>%
  mutate(time1 = as_date(time1),
         time2 = as_date(time2))

p66139_2 <- p66139_2 %>%
  left_join(annual, by = "sat_time")

mean(p66139_2$ndvi)
sd(p66139_2$ndvi)
min(p66139_2$ndvi)
```

Plot:

```{r}

p66139_2 %>%
  mutate(year = year(date),
         date = as.Date(date)) %>%
  ggplot(aes(x= date, y = ndvi)) +
  scale_x_date() +
  # NDVI sd (full time series)
  # geom_segment(aes(x = p66139_2$date[270]+(365*2),
  #               xend = p66139_2$date[270]+(365*2),
  #               y = 0.7632497-0.08261055,
  #               yend = 0.7632497+0.08261055),
  #           color= "#66c2a5",
  #           size= 0.75,
  #           alpha = 0.25,
  #           linetype = 1,
  #           arrow = arrow(ends = "both", angle = 90, length = unit(.1,"cm"))) +
  geom_rect(aes(xmin = p66139_2$date[1]-365, xmax = p66139_2$date[270]+365, ymin = ndvi_sd_1, ymax = ndvi_sd_2),
             fill = "gray95",
             #color= "gray80",
             alpha = 0.10) +
  # annual lines
  geom_vline(xintercept = as.numeric(p66139_2$time1[c(1,16,31,43,56,63,80,95,120,132,138,143,151,156,160,167,171,181,192,202,210,217,226,233,240,250,258,270)]),
             color = "gray90",
             linetype = 5,
             size = 0.25) +
  geom_vline(xintercept = as.numeric(p66139_2$time1[c(270)]+365),
             color = "gray90",
             linetype = 5,
             size = 0.25) +
  # annual boxes
  # geom_rect(aes(xmin = time1, xmax = time2, ymin = ndvi_sd_1, ymax = ndvi_sd_2),
  #           fill = "gray95",
  #           #color= "gray80",
  #           alpha = 0.10) +
  # annual ndvi mean
  # geom_segment(aes(x = time1, xend = time2, y = ndvi_annual_mean, yend = ndvi_annual_mean),
  #              color = "#66c2a5",
  #              size = 0.50,
  #              linetype = 1,
  #              alpha = 0.25) +
  geom_point(aes(x= time2 - 182.5, y = ndvi_annual_mean),
             color = "#66c2a5",
             shape = 16) +
  geom_errorbar(aes(x= time2 - 182.5,
                    ymin = ndvi_annual_mean - ndvi_annual_sd,
                    ymax= ndvi_annual_mean + ndvi_annual_sd),
                color = "#66c2a5") +
  # annual ndvi sd
  # geom_segment(aes(x = time1, xend = time2, y = ndvi_sd_1, yend = ndvi_sd_1),
  #              color = "#66c2a5",
  #              #size = 1,
  #              linetype = 3) +
  # geom_segment(aes(x = time1, xend = time2, y = ndvi_sd_2, yend = ndvi_sd_2),
  #              color = "#66c2a5",
  #              #size = 1,
  #              linetype = 3) +
 
  # ndvi values - time series
  geom_line(aes(x= date, y = ndvi),
            color = "grey65",
            alpha = 0.75) +
  scale_y_continuous(limits = c(0.25,1)) +
  # ndvi values - time series
  # geom_point(aes(x= date, y = ndvi, color = is_min),
  #            shape = 20,
  #            alpha = 0.90) +
  scale_color_manual(values = c("#fc8d62", "gray90")) +
  # min ndvi value
  geom_point(aes(x= p66139_2$date[73], y = 0.2649842),
             shape = 19,
             size= 2,
             color = "#fc8d62") +
  # breaks
  geom_vline(xintercept = as.numeric(p66139_2$date[c(71, 119, 260)]),
             color = "gray20",
             linetype = 2,
             size = 0.75) +
  # data collection date
  geom_vline(xintercept = as.numeric(p66139_2$date[203]),
             color = "gray60",
             linetype = "solid",
             size = 0.75) +
  # mean NDVI (full time series)
  geom_hline(yintercept = 0.7632497,
             color = "gray75",
             size = 0.6,
             linetype = 3) +
  # age since last disturbance
   annotate("segment",
            x = p66139_2$date[119]+10,
            xend = p66139_2$date[203]-10,
            y = 0.4,
            yend = 0.4,
            color = "#8da0cb",
            size = 0.75,
            arrow = arrow(ends = "both", length = unit(.15,"cm"))) +
# geom_segment(aes(x = p66139_2$date[119],
#                    xend = p66139_2$date[203],
#                    y = 0.4,
#                    yend = 0.4),
#                color = "#8da0cb",
#                size = 1,
#                linetype = 1,
#                lineend = "round") +
  theme_classic2() +
  theme(legend.position = "none") 

```


# Figure 5. Forest structure ~ RS variables